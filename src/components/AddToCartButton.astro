---
// AddToCartButton.astro - Interactive add to cart button component
interface Props {
  productId: number;
  productName: string;
  productPrice: number;
  productImage: string;
  productDescription?: string;
}

const { productId, productName, productPrice, productImage, productDescription = '' } = Astro.props;
---

<div class="add-to-cart-container">
  <div class="quantity-selector">
    <button class="qty-btn qty-minus" data-product-id={productId}>−</button>
    <input 
      type="number" 
      class="qty-input" 
      value="1" 
      min="1" 
      data-product-id={productId}
    />
    <button class="qty-btn qty-plus" data-product-id={productId}>+</button>
  </div>
  
  <button 
    class="add-to-cart-btn" 
    data-product-id={productId}
    data-product-name={productName}
    data-product-price={productPrice}
    data-product-image={productImage}
    data-product-description={productDescription}
  >
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="9" cy="21" r="1"></circle>
      <circle cx="20" cy="21" r="1"></circle>
      <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
    </svg>
    Añadir al carrito
  </button>
</div>

<div class="add-to-cart-notification" id="notification-{productId}">
  ¡Producto añadido al carrito!
</div>

<script>
  function initAddToCart() {
    const buttons = document.querySelectorAll('.add-to-cart-btn');
    const minusButtons = document.querySelectorAll('.qty-minus');
    const plusButtons = document.querySelectorAll('.qty-plus');
    const qtyInputs = document.querySelectorAll('.qty-input');

    // Quantity minus
    minusButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const productId = (e.target as HTMLElement).getAttribute('data-product-id');
        const input = document.querySelector(`.qty-input[data-product-id="${productId}"]`) as HTMLInputElement;
        if (input && parseInt(input.value) > 1) {
          input.value = (parseInt(input.value) - 1).toString();
        }
      });
    });

    // Quantity plus
    plusButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const productId = (e.target as HTMLElement).getAttribute('data-product-id');
        const input = document.querySelector(`.qty-input[data-product-id="${productId}"]`) as HTMLInputElement;
        if (input) {
          input.value = (parseInt(input.value) + 1).toString();
        }
      });
    });

    // Ensure input is numeric
    qtyInputs.forEach(input => {
      input.addEventListener('change', (e) => {
        let value = parseInt((e.target as HTMLInputElement).value);
        if (isNaN(value) || value < 1) {
          (e.target as HTMLInputElement).value = '1';
        }
      });
    });

    // Add to cart button click
    buttons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const productId = parseInt(btn.getAttribute('data-product-id') || '0');
        const productName = btn.getAttribute('data-product-name') || '';
        const productPrice = parseFloat(btn.getAttribute('data-product-price') || '0');
        const productImage = btn.getAttribute('data-product-image') || '';
        const productDescription = btn.getAttribute('data-product-description') || '';
        
        const qtyInput = document.querySelector(`.qty-input[data-product-id="${productId}"]`) as HTMLInputElement;
        const quantity = parseInt(qtyInput?.value || '1');

        // Add to cart
        const cart = JSON.parse(localStorage.getItem('k2spiceshop_cart') || '[]');
        const existingItem = cart.find((item: any) => item.id === productId);

        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          cart.push({
            id: productId,
            name: productName,
            price: productPrice,
            image: productImage,
            description: productDescription,
            quantity: quantity
          });
        }

        localStorage.setItem('k2spiceshop_cart', JSON.stringify(cart));
        
        // Dispatch custom event to update cart count
        window.dispatchEvent(new Event('cartUpdated'));

        // Show notification
        const notification = document.getElementById(`notification-${productId}`);
        if (notification) {
          notification.classList.add('show');
          setTimeout(() => {
            notification.classList.remove('show');
          }, 2000);
        }

        // Reset quantity
        qtyInput.value = '1';
      });
    });
  }

  initAddToCart();

  // Reinitialize on navigation
  document.addEventListener('astro:after-swap', initAddToCart);
</script>

<style>
  .add-to-cart-container {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin: 1.5rem 0;
  }

  .quantity-selector {
    display: flex;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
    background: #f9f9f9;
  }

  .qty-btn {
    background: none;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 18px;
    color: #333;
    transition: background 0.2s;
  }

  .qty-btn:hover {
    background: #e9e9e9;
  }

  .qty-input {
    border: none;
    width: 50px;
    text-align: center;
    font-size: 16px;
    padding: 0.5rem 0;
    background: transparent;
  }

  .qty-input:focus {
    outline: none;
  }

  .add-to-cart-btn {
    flex: 1;
    background: #d9534f;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: background 0.3s ease, transform 0.2s ease;
  }

  .add-to-cart-btn:hover {
    background: #c9302c;
    transform: translateY(-2px);
  }

  .add-to-cart-btn:active {
    transform: translateY(0);
  }

  .add-to-cart-btn svg {
    width: 20px;
    height: 20px;
  }

  .add-to-cart-notification {
    position: fixed;
    bottom: -100px;
    left: 50%;
    transform: translateX(-50%);
    background: #27ae60;
    color: white;
    padding: 1rem 2rem;
    border-radius: 4px;
    transition: bottom 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
  }

  .add-to-cart-notification.show {
    bottom: 20px;
  }

  @media (max-width: 600px) {
    .add-to-cart-container {
      flex-direction: column;
      gap: 0.75rem;
    }

    .add-to-cart-btn {
      width: 100%;
    }

    .quantity-selector {
      width: 100%;
    }
  }
</style>